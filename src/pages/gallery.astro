---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Sidebar from '@/components/Sidebar.astro';
import MasonryGrid from '@/components/MasonryGrid.tsx';
import FilterBar from '@/components/FilterBar.tsx';
import { getModels, getTags, getPrompts, getModelCounts } from '@/lib/db/queries';

Astro.response.headers.set('Cache-Control', 'public, s-maxage=30, stale-while-revalidate=120');

const modelId = Astro.url.searchParams.get('model') ?? undefined;
const tagParams = Astro.url.searchParams.getAll('tags');
const sort = (Astro.url.searchParams.get('sort') as 'latest' | 'popular' | 'random') ?? 'latest';

const [allModels, allTags, counts] = await Promise.all([
  getModels(),
  getTags(),
  getModelCounts(),
]);

const countMap = Object.fromEntries(counts.map((c) => [c.modelId, c.count]));
const modelsWithCounts = allModels.map((m) => ({
  id: m.id,
  name: m.name,
  type: m.type,
  count: countMap[m.id] ?? 0,
}));

const { items, hasMore } = await getPrompts({
  modelId,
  tagIds: tagParams.length > 0 ? tagParams : undefined,
  sort,
  limit: 30,
});

const selectedModelName = modelId
  ? allModels.find((m) => m.id === modelId)?.name ?? 'Model'
  : null;

const pageTitle = selectedModelName
  ? `${selectedModelName} Prompts — PromptVault`
  : 'AI Prompt Gallery — PromptVault | Curated Prompts for Midjourney, FLUX, Stable Diffusion & More';

const pageDesc = selectedModelName
  ? `Browse curated ${selectedModelName} prompts with full parameters for pixel-perfect reproduction.`
  : 'Browse hundreds of curated AI image & video prompts with full parameters. One-click copy for pixel-perfect reproduction across Midjourney, FLUX, Stable Diffusion, DALL-E, Sora and more.';
---

<BaseLayout
  title={pageTitle}
  description={pageDesc}
  canonical={`https://getpt.net/gallery${modelId ? `?model=${modelId}` : ''}`}
>
  <div class="flex min-h-[calc(100vh-52px)]">
    <Sidebar
      models={modelsWithCounts}
      currentModelId={modelId}
    />

    <div class="ml-[220px] flex-1 flex flex-col min-w-0 max-md:ml-0">
      <FilterBar
        client:load
        tags={allTags.map((t) => ({ id: t.id, name: t.name }))}
        currentTags={tagParams}
        currentSort={sort}
      />

      {items.length > 0 ? (
        <MasonryGrid
          client:load
          initialItems={items}
          hasMore={hasMore}
          modelId={modelId}
          tagIds={tagParams}
          sort={sort}
        />
      ) : (
        <div class="flex-1 flex items-center justify-center text-text-3 text-sm">
          <div class="text-center">
            <p class="mb-3">No results for current filters.</p>
            <a href="/gallery" class="text-accent hover:text-accent-hover transition-colors">Clear Filters</a>
          </div>
        </div>
      )}
    </div>
  </div>
</BaseLayout>
