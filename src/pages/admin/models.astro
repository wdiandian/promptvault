---
import AdminLayout from '@/layouts/AdminLayout.astro';
import DataTable from '@/components/admin/DataTable.tsx';
import { db } from '@/lib/db/index';
import { models } from '@/lib/db/schema';
import { asc } from 'drizzle-orm';

const allModels = await db.select().from(models).orderBy(asc(models.sort));

const tableData = allModels.map((m) => ({
  id: m.id,
  name: m.name,
  type: m.type,
  version: m.version ?? '—',
  pinnedLabel: m.isPinned ? 'Yes' : '—',
  color: m.color,
  sort: m.sort,
  status: m.status,
}));
---

<AdminLayout title="Models">
  <h2 class="text-[1.125rem] font-bold tracking-[-0.02em] mb-4">Model Management</h2>

  <details class="mb-6 bg-bg-card border border-border rounded-[10px] overflow-hidden">
    <summary class="px-5 py-3 cursor-pointer text-[.8125rem] font-semibold text-accent hover:bg-bg-hover transition-colors">
      + New Model
    </summary>
    <div class="px-5 py-4 border-t border-border">
      <form id="model-form" class="flex flex-col gap-3.5">
        <div class="flex gap-3.5">
          <div class="flex-1">
            <label class="block text-xs text-text-3 mb-1 font-medium">Name</label>
            <input name="name" type="text" required placeholder="e.g. Midjourney v6" class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3" />
          </div>
          <div class="flex-1">
            <label class="block text-xs text-text-3 mb-1 font-medium">Type</label>
            <select name="type" class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text">
              <option value="image">Image</option>
              <option value="video">Video</option>
            </select>
          </div>
        </div>
        <div class="flex gap-3.5">
          <div class="flex-1">
            <label class="block text-xs text-text-3 mb-1 font-medium">Version</label>
            <input name="version" type="text" placeholder="e.g. v6.1" class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3" />
          </div>
          <div class="flex-1">
            <label class="block text-xs text-text-3 mb-1 font-medium">Color</label>
            <input name="color" type="text" placeholder="#E8D44D" value="#e8634a" class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3" />
          </div>
        </div>
        <div class="flex gap-3.5">
          <div class="flex-1">
            <label class="block text-xs text-text-3 mb-1 font-medium">Website</label>
            <input name="website" type="url" placeholder="https://example.com" class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3" />
          </div>
          <div class="flex-1">
            <label class="block text-xs text-text-3 mb-1 font-medium">Sort Order</label>
            <input name="sort" type="number" value="0" class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3" />
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input name="isPinned" type="checkbox" id="isPinned" class="accent-accent w-4 h-4" />
          <label for="isPinned" class="text-xs text-text-3 font-medium">Pin to Featured</label>
        </div>
        <div class="flex justify-end pt-2 border-t border-border">
          <button type="submit" class="px-[22px] py-2.5 rounded-sm text-[.8125rem] font-semibold bg-accent text-white hover:bg-accent-hover transition-colors">
            Create Model
          </button>
        </div>
      </form>
    </div>
  </details>

  <DataTable
    client:load
    data={tableData}
    searchKeys={['name', 'type']}
    emptyMessage="No models yet. Run the seed script to populate."
    columns={[
      { key: 'name', label: 'Name', sortable: true, className: 'text-[#f0f0f0] font-medium' },
      { key: 'type', label: 'Type', sortable: true, className: 'text-[#636363] capitalize' },
      { key: 'version', label: 'Version', className: 'text-[#636363]' },
      { key: 'pinnedLabel', label: 'Pinned', className: 'text-[#636363]' },
      { key: 'sort', label: 'Sort', sortable: true, type: 'number' },
      { key: 'status', label: 'Status', type: 'badge' },
    ]}
  />

  <script>
    const form = document.getElementById('model-form') as HTMLFormElement;
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const res = await fetch('/api/admin/models', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: fd.get('name'),
          type: fd.get('type'),
          version: fd.get('version'),
          color: fd.get('color'),
          website: fd.get('website'),
          sort: parseInt(fd.get('sort') as string) || 0,
          isPinned: fd.has('isPinned'),
        }),
      });
      if (res.ok) window.location.reload();
    });
  </script>
</AdminLayout>
