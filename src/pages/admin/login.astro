---
import BaseLayout from '@/layouts/BaseLayout.astro';

const session = Astro.cookies.get('admin_session')?.value;
if (session) {
  const { generateSessionToken } = await import('@/middleware');
  if (session === generateSessionToken()) {
    return Astro.redirect('/admin');
  }
}
---

<BaseLayout title="Admin Login â€” PromptVault" noindex>
  <div class="min-h-[calc(100vh-52px)] flex items-center justify-center">
    <div class="w-full max-w-[380px] p-7 bg-bg-card border border-border rounded-[10px]">
      <h1 class="text-lg font-bold tracking-[-0.02em] mb-1">Admin Login</h1>
      <p class="text-[.8125rem] text-text-3 mb-6">Sign in to manage content</p>

      <form id="login-form">
        <div class="mb-3.5">
          <label for="email" class="block text-xs text-text-3 mb-1 font-medium">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            required
            class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3"
            placeholder="admin@promptvault.com"
          />
        </div>
        <div class="mb-5">
          <label for="password" class="block text-xs text-text-3 mb-1 font-medium">Password</label>
          <input
            id="password"
            name="password"
            type="password"
            required
            class="w-full bg-bg-input border border-border rounded-sm px-3.5 py-2.5 text-sm outline-none focus:border-accent transition-[border] text-text placeholder:text-text-3"
            placeholder="Enter password"
          />
        </div>

        <p id="error-msg" class="text-red text-xs mb-3 hidden">Invalid credentials</p>

        <button
          type="submit"
          class="w-full bg-accent text-white py-2.5 rounded-sm text-[.8125rem] font-semibold transition-colors hover:bg-accent-hover"
        >
          Sign In
        </button>
      </form>
    </div>
  </div>

  <script>
    const form = document.getElementById('login-form') as HTMLFormElement;
    const errorMsg = document.getElementById('error-msg') as HTMLParagraphElement;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.classList.add('hidden');

      const data = new FormData(form);
      const res = await fetch('/api/admin/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: data.get('email'),
          password: data.get('password'),
        }),
      });

      if (res.ok) {
        window.location.href = '/admin';
      } else {
        errorMsg.classList.remove('hidden');
      }
    });
  </script>
</BaseLayout>
